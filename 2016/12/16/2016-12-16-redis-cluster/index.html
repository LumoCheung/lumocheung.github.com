<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="Redis 是一个开源（BSD许可）的，内存中的数据结构存储系统，它可以用作数据库、缓存和消息中间件。 它支持多种类型的数据结构，如 字符串（strings）， 散列（hashes）， 列表（lists）， 集合（sets）， 有序集合（sorted sets） 与范围查询， bitmaps， hyperloglogs">
<meta property="og:type" content="article">
<meta property="og:title" content="redis-cluster研究和使用">
<meta property="og:url" content="http://lumocheung.github.io/2016/12/16/2016-12-16-redis-cluster/index.html">
<meta property="og:site_name" content="LumoCheung的技术博客">
<meta property="og:description" content="Redis 是一个开源（BSD许可）的，内存中的数据结构存储系统，它可以用作数据库、缓存和消息中间件。 它支持多种类型的数据结构，如 字符串（strings）， 散列（hashes）， 列表（lists）， 集合（sets）， 有序集合（sorted sets） 与范围查询， bitmaps， hyperloglogs 和 地理空间（geospatial） 索引半径查询。 Redis 内置了 复制">
<meta property="og:image" content="http://lumocheung.github.io/img/ewcx2640qfhdp35lmrjsnyu9aoiv8kbgtz71.jpg">
<meta property="og:image" content="http://lumocheung.github.io/img/863u92amvl1n4w7r5pxbkoczdsjtyq0egihf.jpg">
<meta property="og:image" content="http://lumocheung.github.io/img/v5m7943ukizxeo0h81np2wjydsc6rlgbfatq.jpg">
<meta property="og:updated_time" content="2017-11-21T03:01:52.157Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="redis-cluster研究和使用">
<meta name="twitter:description" content="Redis 是一个开源（BSD许可）的，内存中的数据结构存储系统，它可以用作数据库、缓存和消息中间件。 它支持多种类型的数据结构，如 字符串（strings）， 散列（hashes）， 列表（lists）， 集合（sets）， 有序集合（sorted sets） 与范围查询， bitmaps， hyperloglogs 和 地理空间（geospatial） 索引半径查询。 Redis 内置了 复制">
<meta name="twitter:image" content="http://lumocheung.github.io/img/ewcx2640qfhdp35lmrjsnyu9aoiv8kbgtz71.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://lumocheung.github.io/2016/12/16/2016-12-16-redis-cluster/"/>





  <title>redis-cluster研究和使用 | LumoCheung的技术博客</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">LumoCheung的技术博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://lumocheung.github.io/2016/12/16/2016-12-16-redis-cluster/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="LumoCheung">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LumoCheung的技术博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">redis-cluster研究和使用</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-12-16T00:00:00+08:00">
                2016-12-16
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>Redis 是一个开源（BSD许可）的，内存中的数据结构存储系统，它可以用作数据库、缓存和消息中间件。 它支持多种类型的数据结构，如 字符串（strings）， 散列（hashes）， 列表（lists）， 集合（sets）， 有序集合（sorted sets） 与范围查询， bitmaps， hyperloglogs 和 地理空间（geospatial） 索引半径查询。 Redis 内置了 复制（replication），LUA脚本（Lua scripting）， LRU驱动事件（LRU eviction），事务（transactions） 和不同级别的 磁盘持久化（persistence）， 并通过 Redis哨兵（Sentinel）和自动 分区（Cluster）提供高可用性（high availability）。</p>
<h2 id="一-关于redis-cluster"><a href="#一-关于redis-cluster" class="headerlink" title="一 关于redis cluster"></a>一 关于redis cluster</h2><h3 id="1-redis-cluster的现状"><a href="#1-redis-cluster的现状" class="headerlink" title="1 redis cluster的现状"></a>1 redis cluster的现状</h3><p>reids-cluster计划在redis3.0中推出，可以看作者antirez的声明:<br><a href="http://antirez.com/news/49" target="_blank" rel="noopener">http://antirez.com/news/49</a><br>(ps:跳票了好久，今年貌似加快速度了),目前的最新版本见:<br><a href="https://raw.githubusercontent.com/antirez/redis/3.0/00-RELEASENOTES" target="_blank" rel="noopener">https://raw.githubusercontent.com/antirez/redis/3.0/00-RELEASENOTES</a>  </p>
<p>目前redis支持的cluster特性(已测试):<br>1) 节点自动发现<br>2) slave-&gt;master 选举,集群容错<br>3) Hot resharding:在线分片<br>4) 集群管理:cluster xxx<br>5) 基于配置(nodes-port.conf)的集群管理<br>6) ASK 转向/MOVED 转向机制.   </p>
<h3 id="2-redis-cluster-架构"><a href="#2-redis-cluster-架构" class="headerlink" title="2 redis cluster 架构"></a>2 redis cluster 架构</h3><h4 id="1-redis-cluster架构图"><a href="#1-redis-cluster架构图" class="headerlink" title="1) redis-cluster架构图"></a>1) redis-cluster架构图</h4><p><img src="/img/ewcx2640qfhdp35lmrjsnyu9aoiv8kbgtz71.jpg" alt="redis-cluster架构图"></p>
<p>架构细节:<br>a) 所有的redis节点彼此互联(PING-PONG机制),内部使用二进制协议优化传输速度和带宽.<br>b) 节点的fail是通过集群中超过半数的节点检测失效时才生效.<br>c) 客户端与redis节点直连,不需要中间proxy层.客户端不需要连接集群所有节点,连接集群中任何一个可用节点即可<br>d) redis-cluster把所有的物理节点映射到[0-16383]slot上,cluster 负责维护node&lt;-&gt;slot&lt;-&gt;key   </p>
<h4 id="2-redis-cluster选举-容错"><a href="#2-redis-cluster选举-容错" class="headerlink" title="2) redis-cluster选举:容错"></a>2) redis-cluster选举:容错</h4><p><img src="/img/863u92amvl1n4w7r5pxbkoczdsjtyq0egihf.jpg" alt="redis-cluster选举图"></p>
<p>a) 领着选举过程是集群中所有master参与,如果半数以上master节点与master节点通信超过(cluster-node-timeout),认为当前master节点挂掉.<br>b) 什么时候整个集群不可用(cluster_state:fail)?<br>    i. 如果集群任意master挂掉,且当前master没有slave.集群进入fail状态,也可以理解成集群的slot映射[0-16383]不完成时进入fail状态.<br>    ps : redis-3.0.0.rc1加入cluster-require-full-coverage参数,默认关闭,打开集群兼容部分失败.<br>    ii. 如果集群超过半数以上master挂掉，无论是否有slave集群进入fail状态.<br>    ps:当集群不可用时,所有对集群的操作做都不可用，收到((error) CLUSTERDOWN The cluster is down)错误   </p>
<h2 id="二-redis-cluster的使用"><a href="#二-redis-cluster的使用" class="headerlink" title="二 redis cluster的使用"></a>二 redis cluster的使用</h2><h3 id="1-安装redis-cluster"><a href="#1-安装redis-cluster" class="headerlink" title="1 安装redis cluster"></a>1 安装redis cluster</h3><p><em>安装redis-cluster依赖:redis-cluster的依赖库在使用时有兼容问题,在reshard时会遇到各种错误,请按指定版本安装.</em></p>
<p><em>参考文档中有关于ruby比较新版本的安装方法</em></p>
<p>1) 确保系统安装zlib,否则gem install会报(no such file to load – zlib)</p>
<p><em>centos自带，如需要安装，最好官网最新版</em></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#download:zlib-1.2.6.tar  </span></span><br><span class="line">./configure  </span><br><span class="line">make  </span><br><span class="line">make install</span><br></pre></td></tr></table></figure>
<p>2) 安装ruby:version(1.9.2)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ruby1.9.2   </span></span><br><span class="line"><span class="built_in">cd</span> /path/ruby  </span><br><span class="line">./configure -prefix=/usr/<span class="built_in">local</span>/ruby  </span><br><span class="line">make  </span><br><span class="line">make install  </span><br><span class="line">sudo cp ruby /usr/<span class="built_in">local</span>/bin</span><br></pre></td></tr></table></figure>
<p>3) 安装rubygem:version(1.8.16)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># rubygems-1.8.16.tgz  </span></span><br><span class="line"><span class="built_in">cd</span> /path/gem  </span><br><span class="line">sudo ruby setup.rb  </span><br><span class="line">sudo cp bin/gem /usr/<span class="built_in">local</span>/bin</span><br></pre></td></tr></table></figure>
<p>4) 安装gem-redis:version(3.0.0)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gem install redis --version 3.0.0  </span><br><span class="line"><span class="comment">#由于源的原因，可能下载失败，就手动下载下来安装  </span></span><br><span class="line"><span class="comment">#download地址:http://rubygems.org/gems/redis/versions/3.0.0  </span></span><br><span class="line">gem install -l /data/soft/redis-3.0.0.gem</span><br></pre></td></tr></table></figure>
<p>5) 安装redis-cluster</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /path/redis  </span><br><span class="line">make  </span><br><span class="line">sudo cp /opt/redis/src/redis-server /usr/<span class="built_in">local</span>/bin  </span><br><span class="line">sudo cp /opt/redis/src/redis-cli /usr/<span class="built_in">local</span>/bin  </span><br><span class="line">sudo cp /opt/redis/src/redis-trib.rb /usr/<span class="built_in">local</span>/bin</span><br></pre></td></tr></table></figure>
<h3 id="2-配置redis-cluster"><a href="#2-配置redis-cluster" class="headerlink" title="2 配置redis cluster"></a>2 配置redis cluster</h3><h4 id="1-redis配置文件结构"><a href="#1-redis配置文件结构" class="headerlink" title="1) redis配置文件结构:"></a>1) redis配置文件结构:</h4><p><img src="/img/v5m7943ukizxeo0h81np2wjydsc6rlgbfatq.jpg" alt="redis配置文件结构"></p>
<p>使用包含(include)把通用配置和特殊配置分离,方便维护.</p>
<h4 id="2-redis通用配置"><a href="#2-redis通用配置" class="headerlink" title="2)redis通用配置."></a>2)redis通用配置.</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#GENERAL  </span></span><br><span class="line">daemonize no  </span><br><span class="line">tcp-backlog 511  </span><br><span class="line">timeout 0  </span><br><span class="line">tcp-keepalive 0  </span><br><span class="line">loglevel notice  </span><br><span class="line">databases 16  </span><br><span class="line">dir /opt/redis/data  </span><br><span class="line">slave-serve-stale-data yes  </span><br><span class="line"><span class="comment">#slave只读  </span></span><br><span class="line">slave-read-only yes  </span><br><span class="line"><span class="comment">#not use default  </span></span><br><span class="line">repl-disable-tcp-nodelay yes  </span><br><span class="line">slave-priority 100  </span><br><span class="line"><span class="comment">#打开aof持久化  </span></span><br><span class="line">appendonly yes  </span><br><span class="line"><span class="comment">#每秒一次aof写  </span></span><br><span class="line">appendfsync everysec  </span><br><span class="line"><span class="comment">#关闭在aof rewrite的时候对新的写操作进行fsync  </span></span><br><span class="line">no-appendfsync-on-rewrite yes  </span><br><span class="line">auto-aof-rewrite-min-size 64mb  </span><br><span class="line">lua-time-limit 5000  </span><br><span class="line"><span class="comment">#打开redis集群  </span></span><br><span class="line">cluster-enabled yes  </span><br><span class="line"><span class="comment">#节点互连超时的阀值  </span></span><br><span class="line">cluster-node-timeout 15000  </span><br><span class="line">cluster-migration-barrier 1  </span><br><span class="line">slowlog-log-slower-than 10000  </span><br><span class="line">slowlog-max-len 128  </span><br><span class="line">notify-keyspace-events <span class="string">""</span>  </span><br><span class="line"><span class="built_in">hash</span>-max-ziplist-entries 512  </span><br><span class="line"><span class="built_in">hash</span>-max-ziplist-value 64  </span><br><span class="line">list-max-ziplist-entries 512  </span><br><span class="line">list-max-ziplist-value 64  </span><br><span class="line"><span class="built_in">set</span>-max-intset-entries 512  </span><br><span class="line">zset-max-ziplist-entries 128  </span><br><span class="line">zset-max-ziplist-value 64  </span><br><span class="line">activerehashing yes  </span><br><span class="line">client-output-buffer-limit normal 0 0 0  </span><br><span class="line">client-output-buffer-limit slave 256mb 64mb 60  </span><br><span class="line">client-output-buffer-limit pubsub 32mb 8mb 60  </span><br><span class="line">hz 10  </span><br><span class="line">aof-rewrite-incremental-fsync yes</span><br></pre></td></tr></table></figure>
<h4 id="3-redis特殊配置"><a href="#3-redis特殊配置" class="headerlink" title="3)redis特殊配置."></a>3)redis特殊配置.</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#包含通用配置  </span></span><br><span class="line">include /opt/redis/redis-common.conf  </span><br><span class="line"><span class="comment">#监听tcp端口  </span></span><br><span class="line">port 6379  </span><br><span class="line"><span class="comment">#最大可用内存  </span></span><br><span class="line">maxmemory 100m  </span><br><span class="line"><span class="comment">#内存耗尽时采用的淘汰策略:  </span></span><br><span class="line"><span class="comment"># volatile-lru -&gt; remove the key with an expire set using an LRU algorithm  </span></span><br><span class="line"><span class="comment"># allkeys-lru -&gt; remove any key accordingly to the LRU algorithm  </span></span><br><span class="line"><span class="comment"># volatile-random -&gt; remove a random key with an expire set  </span></span><br><span class="line"><span class="comment"># allkeys-random -&gt; remove a random key, any key  </span></span><br><span class="line"><span class="comment"># volatile-ttl -&gt; remove the key with the nearest expire time (minor TTL)  </span></span><br><span class="line"><span class="comment"># noeviction -&gt; don't expire at all, just return an error on write operations  </span></span><br><span class="line">maxmemory-policy allkeys-lru  </span><br><span class="line"><span class="comment">#aof存储文件  </span></span><br><span class="line">appendfilename <span class="string">"appendonly-6379.aof"</span>  </span><br><span class="line"><span class="comment">#不开启rdb存储,只用于添加slave过程  </span></span><br><span class="line">dbfilename dump-6379.rdb  </span><br><span class="line"><span class="comment">#cluster配置文件(启动自动生成)  </span></span><br><span class="line">cluster-config-file nodes-6379.conf  </span><br><span class="line"><span class="comment">#部署在同一机器的redis实例，把auto-aof-rewrite搓开，因为cluster环境下内存占用基本一致.  </span></span><br><span class="line"><span class="comment">#防止同意机器下瞬间fork所有redis进程做aof rewrite,占用大量内存(ps:cluster必须开启aof)  </span></span><br><span class="line">auto-aof-rewrite-percentage 80-100</span><br></pre></td></tr></table></figure>
<h3 id="3-cluster-操作"><a href="#3-cluster-操作" class="headerlink" title="3 cluster 操作"></a>3 cluster 操作</h3><p>cluster集群相关命令,更多redis相关命令见文档:<br><a href="http://redis.readthedocs.org/en/latest/" target="_blank" rel="noopener">http://redis.readthedocs.org/en/latest/</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">集群  </span><br><span class="line">CLUSTER INFO 打印集群的信息  </span><br><span class="line">CLUSTER NODES 列出集群当前已知的所有节点（node），以及这些节点的相关信息。  </span><br><span class="line">节点  </span><br><span class="line">CLUSTER MEET &lt;ip&gt; &lt;port&gt; 将 ip 和 port 所指定的节点添加到集群当中，让它成为集群的一份子。  </span><br><span class="line">CLUSTER FORGET &lt;node_id&gt; 从集群中移除 node_id 指定的节点。  </span><br><span class="line">CLUSTER REPLICATE &lt;node_id&gt; 将当前节点设置为 node_id 指定的节点的从节点。  </span><br><span class="line">CLUSTER SAVECONFIG 将节点的配置文件保存到硬盘里面。  </span><br><span class="line">槽(slot)  </span><br><span class="line">CLUSTER ADDSLOTS &lt;slot&gt; [slot ...] 将一个或多个槽（slot）指派（assign）给当前节点。  </span><br><span class="line">CLUSTER DELSLOTS &lt;slot&gt; [slot ...] 移除一个或多个槽对当前节点的指派。  </span><br><span class="line">CLUSTER FLUSHSLOTS 移除指派给当前节点的所有槽，让当前节点变成一个没有指派任何槽的节点。  </span><br><span class="line">CLUSTER SETSLOT &lt;slot&gt; NODE &lt;node_id&gt; 将槽 slot 指派给 node_id 指定的节点，如果槽已经指派给另一个节点，那么先让另一个节点删除该槽&gt;，然后再进行指派。  </span><br><span class="line">CLUSTER SETSLOT &lt;slot&gt; MIGRATING &lt;node_id&gt; 将本节点的槽 slot 迁移到 node_id 指定的节点中。  </span><br><span class="line">CLUSTER SETSLOT &lt;slot&gt; IMPORTING &lt;node_id&gt; 从 node_id 指定的节点中导入槽 slot 到本节点。  </span><br><span class="line">CLUSTER SETSLOT &lt;slot&gt; STABLE 取消对槽 slot 的导入（import）或者迁移（migrate）。  </span><br><span class="line">键  </span><br><span class="line">CLUSTER KEYSLOT &lt;key&gt; 计算键 key 应该被放置在哪个槽上。  </span><br><span class="line">CLUSTER COUNTKEYSINSLOT &lt;slot&gt; 返回槽 slot 目前包含的键值对数量。  </span><br><span class="line">CLUSTER GETKEYSINSLOT &lt;slot&gt; &lt;count&gt; 返回 count 个 slot 槽中的键。</span><br></pre></td></tr></table></figure>
<h3 id="4-redis-cluster-运维操作"><a href="#4-redis-cluster-运维操作" class="headerlink" title="4 redis cluster 运维操作"></a>4 redis cluster 运维操作</h3><h4 id="1-初始化并构建集群"><a href="#1-初始化并构建集群" class="headerlink" title="1)初始化并构建集群"></a>1)初始化并构建集群</h4><p>1) 启动集群相关节点（必须是空节点,beta3后可以是有数据的节点）,指定配置文件和输出日志</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">redis-server /opt/redis/conf/redis-6380.conf &gt; /opt/redis/logs/redis-6380.log 2&gt;&amp;1 &amp;  </span><br><span class="line">redis-server /opt/redis/conf/redis-6381.conf &gt; /opt/redis/logs/redis-6381.log 2&gt;&amp;1 &amp;  </span><br><span class="line">redis-server /opt/redis/conf/redis-6382.conf &gt; /opt/redis/logs/redis-6382.log 2&gt;&amp;1 &amp;  </span><br><span class="line">redis-server /opt/redis/conf/redis-7380.conf &gt; /opt/redis/logs/redis-7380.log 2&gt;&amp;1 &amp;  </span><br><span class="line">redis-server /opt/redis/conf/redis-7381.conf &gt; /opt/redis/logs/redis-7381.log 2&gt;&amp;1 &amp;  </span><br><span class="line">redis-server /opt/redis/conf/redis-7382.conf &gt; /opt/redis/logs/redis-7382.log 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure>
<p>(2):使用自带的ruby工具(redis-trib.rb)构建集群</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#redis-trib.rb的create子命令构建  </span></span><br><span class="line"><span class="comment">#--replicas 则指定了为Redis Cluster中的每个Master节点配备几个Slave节点  </span></span><br><span class="line"><span class="comment">#节点角色由顺序决定,先master之后是slave(为方便辨认,slave的端口比master大1000)  </span></span><br><span class="line">redis-trib.rb create --replicas 1 10.10.34.14:6380 10.10.34.14:6381 10.10.34.14:6382 10.10.34.14:7380 10.10.34.14:7381 10.10.34.14:7382</span><br></pre></td></tr></table></figure>
<p>(3):检查集群状态</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#redis-trib.rb的check子命令构建  </span></span><br><span class="line"><span class="comment">#ip:port可以是集群的任意节点  </span></span><br><span class="line">redis-trib.rb check 10.10.34.14:6380</span><br></pre></td></tr></table></figure>
<p>最后输出如下信息,没有任何警告或错误，表示集群启动成功并处于ok状态</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[OK] All nodes agree about slots configuration.  </span><br><span class="line">&gt;&gt;&gt; Check <span class="keyword">for</span> open slots...  </span><br><span class="line">&gt;&gt;&gt; Check slots coverage...  </span><br><span class="line">[OK] All 16384 slots covered.</span><br></pre></td></tr></table></figure>
<h4 id="2-添加新master节点"><a href="#2-添加新master节点" class="headerlink" title="2) 添加新master节点"></a>2) 添加新master节点</h4><p>添加一个master节点:创建一个空节点（empty node），然后将某些slot移动到这个空节点上,这个过程目前需要人工干预</p>
<p>a) 根据端口生成配置文件(ps:establish_config.sh是我自己写的输出配置脚本)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh establish_config.sh 6386 &gt; conf/redis-6386.conf</span><br></pre></td></tr></table></figure>
<p>b) 启动节点</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">redis-server /opt/redis/conf/redis-6386.conf &gt; /opt/redis/logs/redis-6386.log 2&gt;&amp;1 &amp;</span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line">c) 加入空节点到集群</span><br><span class="line">add-node  将一个节点添加到集群里面， 第一个是新节点ip:port, 第二个是任意一个已存在节点ip:port</span><br><span class="line"></span><br><span class="line">```bash</span><br><span class="line">redis-trib.rb add-node 10.10.34.14:6386 10.10.34.14:6381</span><br></pre></td></tr></table></figure>
<p>node:新节点没有包含任何数据， 因为它没有包含任何slot。新加入的加点是一个主节点， 当集群需要将某个从节点升级为新的主节点时， 这个新节点不会被选中，同时新的主节点因为没有包含任何slot，不参加选举和failover。</p>
<p>d) 为新节点分配slot</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">redis-trib.rb reshard 10.10.34.14:6386  </span><br><span class="line"><span class="comment">#根据提示选择要迁移的slot数量(ps:这里选择500)  </span></span><br><span class="line">How many slots <span class="keyword">do</span> you want to move (from 1 to 16384)? 500  </span><br><span class="line"><span class="comment">#选择要接受这些slot的node-id  </span></span><br><span class="line">What is the receiving node ID? f51e26b5d5ff74f85341f06f28f125b7254e61bf  </span><br><span class="line"><span class="comment">#选择slot来源:  </span></span><br><span class="line"><span class="comment">#all表示从所有的master重新分配，  </span></span><br><span class="line"><span class="comment">#或者数据要提取slot的master节点id,最后用done结束  </span></span><br><span class="line">Please enter all the <span class="built_in">source</span> node IDs.  </span><br><span class="line">Type <span class="string">'all'</span> to use all the nodes as <span class="built_in">source</span> nodes <span class="keyword">for</span> the <span class="built_in">hash</span> slots.  </span><br><span class="line">Type <span class="string">'done'</span> once you entered all the <span class="built_in">source</span> nodes IDs.  </span><br><span class="line">Source node <span class="comment">#1:all  </span></span><br><span class="line"><span class="comment">#打印被移动的slot后，输入yes开始移动slot以及对应的数据.  </span></span><br><span class="line"><span class="comment">#Do you want to proceed with the proposed reshard plan (yes/no)? yes  </span></span><br><span class="line"><span class="comment">#结束</span></span><br></pre></td></tr></table></figure>
<h4 id="3-添加新的slave节点"><a href="#3-添加新的slave节点" class="headerlink" title="3) 添加新的slave节点"></a>3) 添加新的slave节点</h4><p>a) 前三步操作同添加master一样<br>b) 第四步:redis-cli连接上新节点shell,输入命令:cluster replicate 对应master的node-id</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cluster replicate 2b9ebcbd627ff0fd7a7bbcc5332fb09e72788835</span><br></pre></td></tr></table></figure>
<p>注意:在线添加slave 时，需要bgsave整个master数据，并传递到slave，再由 slave加载rdb文件到内存，rdb生成和传输的过程中消耗Master大量内存和网络IO,以此不建议单实例内存过大，线上小心操作。<br>例如本次添加slave操作产生的rdb文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-rw-r--r-- 1 root root  34946 Apr 17 18:23 dump-6386.rdb  </span><br><span class="line">-rw-r--r-- 1 root root  34946 Apr 17 18:23 dump-7386.rdb</span><br></pre></td></tr></table></figure>
<h4 id="4-在线reshard-数据"><a href="#4-在线reshard-数据" class="headerlink" title="4) 在线reshard 数据:"></a>4) 在线reshard 数据:</h4><p>对于负载/数据不均匀的情况，可以在线reshard slot来解决,方法与添加新master的reshard一样，只是需要reshard的master节点是已存在的老节点.</p>
<h4 id="5-删除一个slave节点"><a href="#5-删除一个slave节点" class="headerlink" title="5) 删除一个slave节点"></a>5) 删除一个slave节点</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#redis-trib del-node ip:port '&lt;node-id&gt;'  </span></span><br><span class="line">redis-trib.rb del-node 10.10.34.14:7386 <span class="string">'c7ee2fca17cb79fe3c9822ced1d4f6c5e169e378'</span></span><br></pre></td></tr></table></figure>
<h4 id="6-删除一个master节点"><a href="#6-删除一个master节点" class="headerlink" title="6)删除一个master节点"></a>6)删除一个master节点</h4><p>a) 删除master节点之前首先要使用reshard移除master的全部slot,然后再删除当前节点(目前redis-trib.rb只能把被删除master的slot对应的数据迁移到一个节点上)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#把10.10.34.14:6386当前master迁移到10.10.34.14:6380上  </span></span><br><span class="line">redis-trib.rb reshard 10.10.34.14:6380  </span><br><span class="line"><span class="comment">#根据提示选择要迁移的slot数量(ps:这里选择500)  </span></span><br><span class="line">How many slots <span class="keyword">do</span> you want to move (from 1 to 16384)? 500(被删除master的所有slot数量)  </span><br><span class="line"><span class="comment">#选择要接受这些slot的node-id(10.10.34.14:6380)  </span></span><br><span class="line">What is the receiving node ID? c4a31c852f81686f6ed8bcd6d1b13accdc947fd2 (ps:10.10.34.14:6380的node-id)  </span><br><span class="line">Please enter all the <span class="built_in">source</span> node IDs.  </span><br><span class="line">  Type <span class="string">'all'</span> to use all the nodes as <span class="built_in">source</span> nodes <span class="keyword">for</span> the <span class="built_in">hash</span> slots.  </span><br><span class="line">  Type <span class="string">'done'</span> once you entered all the <span class="built_in">source</span> nodes IDs.  </span><br><span class="line">Source node <span class="comment">#1:f51e26b5d5ff74f85341f06f28f125b7254e61bf(被删除master的node-id)  </span></span><br><span class="line">Source node <span class="comment">#2:done  </span></span><br><span class="line"><span class="comment">#打印被移动的slot后，输入yes开始移动slot以及对应的数据.  </span></span><br><span class="line"><span class="comment">#Do you want to proceed with the proposed reshard plan (yes/no)? yes</span></span><br></pre></td></tr></table></figure>
<p>b) 删除空master节点</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-trib.rb del-node 10.10.34.14:6386 <span class="string">'f51e26b5d5ff74f85341f06f28f125b7254e61bf'</span></span><br></pre></td></tr></table></figure>
<h2 id="三-redis-cluster-客户端-Jedis"><a href="#三-redis-cluster-客户端-Jedis" class="headerlink" title="三 redis cluster 客户端(Jedis)"></a>三 redis cluster 客户端(Jedis)</h2><h3 id="1-客户端基本操作使用"><a href="#1-客户端基本操作使用" class="headerlink" title="1 客户端基本操作使用"></a>1 客户端基本操作使用</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">private <span class="keyword">static</span> BinaryJedisCluster jc;  </span><br><span class="line">  <span class="keyword">static</span> &#123;  </span><br><span class="line">       <span class="comment">//只给集群里一个实例就可以  </span></span><br><span class="line">        <span class="built_in">Set</span>&lt;HostAndPort&gt; jedisClusterNodes = <span class="keyword">new</span> HashSet&lt;HostAndPort&gt;();  </span><br><span class="line">        jedisClusterNodes.add(<span class="keyword">new</span> HostAndPort(<span class="string">"10.10.34.14"</span>, <span class="number">6380</span>));  </span><br><span class="line">        jedisClusterNodes.add(<span class="keyword">new</span> HostAndPort(<span class="string">"10.10.34.14"</span>, <span class="number">6381</span>));  </span><br><span class="line">        jedisClusterNodes.add(<span class="keyword">new</span> HostAndPort(<span class="string">"10.10.34.14"</span>, <span class="number">6382</span>));  </span><br><span class="line">        jedisClusterNodes.add(<span class="keyword">new</span> HostAndPort(<span class="string">"10.10.34.14"</span>, <span class="number">6383</span>));  </span><br><span class="line">        jedisClusterNodes.add(<span class="keyword">new</span> HostAndPort(<span class="string">"10.10.34.14"</span>, <span class="number">6384</span>));  </span><br><span class="line">        jedisClusterNodes.add(<span class="keyword">new</span> HostAndPort(<span class="string">"10.10.34.14"</span>, <span class="number">7380</span>));  </span><br><span class="line">        jedisClusterNodes.add(<span class="keyword">new</span> HostAndPort(<span class="string">"10.10.34.14"</span>, <span class="number">7381</span>));  </span><br><span class="line">        jedisClusterNodes.add(<span class="keyword">new</span> HostAndPort(<span class="string">"10.10.34.14"</span>, <span class="number">7382</span>));  </span><br><span class="line">        jedisClusterNodes.add(<span class="keyword">new</span> HostAndPort(<span class="string">"10.10.34.14"</span>, <span class="number">7383</span>));  </span><br><span class="line">        jedisClusterNodes.add(<span class="keyword">new</span> HostAndPort(<span class="string">"10.10.34.14"</span>, <span class="number">7384</span>));  </span><br><span class="line">        jc = <span class="keyword">new</span> BinaryJedisCluster(jedisClusterNodes);  </span><br><span class="line">    &#125;  </span><br><span class="line">@Test  </span><br><span class="line">public <span class="keyword">void</span> testBenchRedisSet() throws Exception &#123;  </span><br><span class="line">        final Stopwatch stopwatch = <span class="keyword">new</span> Stopwatch();  </span><br><span class="line">        List list = buildBlogVideos();  </span><br><span class="line">        <span class="keyword">for</span> (int i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;  </span><br><span class="line">            <span class="built_in">String</span> key = <span class="string">"key:"</span> + i;  </span><br><span class="line">            stopwatch.start();  </span><br><span class="line">            byte[] bytes1 = protostuffSerializer.serialize(list);  </span><br><span class="line">            jc.setex(key, <span class="number">60</span> * <span class="number">60</span>, bytes1);  </span><br><span class="line">            stopwatch.stop();  </span><br><span class="line">        &#125;  </span><br><span class="line">        System.out.println(<span class="string">"time="</span> + stopwatch.toString());  </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-redis-cluster客户端的一些坑"><a href="#2-redis-cluster客户端的一些坑" class="headerlink" title="2 redis-cluster客户端的一些坑."></a>2 redis-cluster客户端的一些坑.</h3><p>1) cluster环境下slave默认不接受任何读写操作，在slave执行readonly命令后，可执行读操作<br>2) client端不支持多key操作(mget,mset等)，但当keys集合对应的slot相同时支持mget操作见:hash_tag<br>3) 不支持多数据库，只有一个db，select 0。<br>4) JedisCluster 没有针对byte[]的API，需要自己扩展(附件是我加的基于byte[]的BinaryJedisCluster  api)<br>目前”Jedis-3.0.0-SNAPSHOT”已支持BinaryJedisCluster和基于hash_tag的mget操作.</p>
<p><em>参考文档:</em></p>
<ol>
<li><a href="http://redis.io/topics/cluster-spec" target="_blank" rel="noopener">http://redis.io/topics/cluster-spec</a>   </li>
<li><a href="http://redis.io/topics/cluster-tutorial" target="_blank" rel="noopener">http://redis.io/topics/cluster-tutorial</a></li>
<li><a href="https://my.oschina.net/u/1449160/blog/260764" target="_blank" rel="noopener">ruby安装</a></li>
</ol>

      
    </div>
    
    
    

    

    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者：</strong>
    LumoCheung
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://lumocheung.github.io/2016/12/16/2016-12-16-redis-cluster/" title="redis-cluster研究和使用">http://lumocheung.github.io/2016/12/16/2016-12-16-redis-cluster/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>
    本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！
  </li>
</ul>

      </div>
    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/10/31/2016-10-31-Linux-Find/" rel="next" title="find 命令的参数详解">
                <i class="fa fa-chevron-left"></i> find 命令的参数详解
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/11/20/2017-11-20-java实参与形参/" rel="prev" title="Java 形参与实参[转]">
                Java 形参与实参[转] <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  
    <div class="comments" id="comments">
      <div id="commenthub_thread"></div>
    </div>
  


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">LumoCheung</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">7</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            

          </nav>

          

          <div class="links-of-author motion-element">
            
          </div>

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#一-关于redis-cluster"><span class="nav-number">1.</span> <span class="nav-text">一 关于redis cluster</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-redis-cluster的现状"><span class="nav-number">1.1.</span> <span class="nav-text">1 redis cluster的现状</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-redis-cluster-架构"><span class="nav-number">1.2.</span> <span class="nav-text">2 redis cluster 架构</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-redis-cluster架构图"><span class="nav-number">1.2.1.</span> <span class="nav-text">1) redis-cluster架构图</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-redis-cluster选举-容错"><span class="nav-number">1.2.2.</span> <span class="nav-text">2) redis-cluster选举:容错</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#二-redis-cluster的使用"><span class="nav-number">2.</span> <span class="nav-text">二 redis cluster的使用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-安装redis-cluster"><span class="nav-number">2.1.</span> <span class="nav-text">1 安装redis cluster</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-配置redis-cluster"><span class="nav-number">2.2.</span> <span class="nav-text">2 配置redis cluster</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-redis配置文件结构"><span class="nav-number">2.2.1.</span> <span class="nav-text">1) redis配置文件结构:</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-redis通用配置"><span class="nav-number">2.2.2.</span> <span class="nav-text">2)redis通用配置.</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-redis特殊配置"><span class="nav-number">2.2.3.</span> <span class="nav-text">3)redis特殊配置.</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-cluster-操作"><span class="nav-number">2.3.</span> <span class="nav-text">3 cluster 操作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-redis-cluster-运维操作"><span class="nav-number">2.4.</span> <span class="nav-text">4 redis cluster 运维操作</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-初始化并构建集群"><span class="nav-number">2.4.1.</span> <span class="nav-text">1)初始化并构建集群</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-添加新master节点"><span class="nav-number">2.4.2.</span> <span class="nav-text">2) 添加新master节点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-添加新的slave节点"><span class="nav-number">2.4.3.</span> <span class="nav-text">3) 添加新的slave节点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-在线reshard-数据"><span class="nav-number">2.4.4.</span> <span class="nav-text">4) 在线reshard 数据:</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-删除一个slave节点"><span class="nav-number">2.4.5.</span> <span class="nav-text">5) 删除一个slave节点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-删除一个master节点"><span class="nav-number">2.4.6.</span> <span class="nav-text">6)删除一个master节点</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#三-redis-cluster-客户端-Jedis"><span class="nav-number">3.</span> <span class="nav-text">三 redis cluster 客户端(Jedis)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-客户端基本操作使用"><span class="nav-number">3.1.</span> <span class="nav-text">1 客户端基本操作使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-redis-cluster客户端的一些坑"><span class="nav-number">3.2.</span> <span class="nav-text">2 redis-cluster客户端的一些坑.</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">LumoCheung</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	




  
      <script type="text/javascript">
        var commenthub_id = '33658114';
        var commenthub_website = 'http://dailycast.github.io';
        var commenthub_identifier = '2016/12/16/2016-12-16-redis-cluster/';
        var commenthub_url = 'http://lumocheung.github.io/2016/12/16/2016-12-16-redis-cluster/';
        var commenthub_title = 'redis-cluster研究和使用';
        var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = 'https://commenthub.herokuapp.com/js/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      </script>
  




  





  








  





  

  

  

  

  

  

</body>
</html>
